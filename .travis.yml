language: python
python:
- '3.7'
jobs:
  include:
  - stage: release
    name: deploy to gae
    if: branch = master AND repo = LiaozhiCheng/CramSchoolApp AND fork = false
    python: 3.7
    script: echo "Deploying to gae ..."
    install:
    - pip install pipenv
    before_deploy:
    - pipenv lock -r > requirements.txt
    before_install:
    - openssl aes-256-cbc -K $key -iv $iv -in secrets.tar.enc -out secrets.tar -d
    - tar xvf secrets.tar
    deploy:
      provider: gae
      skip_cleanup: true
      keyfile: client-secret.json
      project: CramSchoolApp
      on:
        branch: main
  - name: release to github
    if: branch = master AND repo = LiaozhiCheng/CramSchoolApp AND fork = false AND commit_message =~ /chore\(release\)/
    language: node_js
    node_js: lts/*
    script:
    - npm run semantic-release